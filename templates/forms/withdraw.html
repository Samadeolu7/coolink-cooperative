<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdrawal Page</title>
</head>
<body>
    <h1>Withdrawal Page</h1>

    <form action="{{ url_for('withdraw') }}" method="post">
        {{ form.csrf_token }}
        {{ form.person.label }} {{ form.person }}
        <br>
        {{ form.balance.label }} {{ form.balance }}
        <br>
        {{ form.amount.label }} {{ form.amount }}
        {% for error in form.amount.errors %}
            <p style="color: red;">{{ error }}</p>
        {% endfor %}
        <br>
        {{ form.submit }}
    </form>

    <script>
        const selectPerson = document.getElementById("person");
        const balanceField = document.getElementById("balance");

        function updateBalance() {
            const selectedPersonId = selectPerson.value;

            // Make an AJAX request to the server to get the balance of the selected person
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `/get_balance/${selectedPersonId}`, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // Update the balance field with the retrieved balance
                        balanceField.value = parseFloat(xhr.responseText).toFixed(2);
                    } else {
                        // Handle errors here (e.g., server error, person not found)
                        balanceField.value = '';
                    }
                }
            };
            xhr.send();
        }

        // Add event listener to update balance field when person selection changes
        selectPerson.addEventListener("change", updateBalance);

        // Call the function initially to set the initial balance value
        updateBalance();
         // Frontend validation to prevent withdrawal more than available balance
         function validateForm() {
            const availableBalance = parseFloat(balanceField.value);
            const withdrawalAmount = parseFloat(amountField.value);

            if (isNaN(withdrawalAmount) || withdrawalAmount <= 0) {
                alert("Please enter a valid withdrawal amount.");
                return false;
            }

            if (withdrawalAmount > availableBalance) {
                alert("Withdrawal amount cannot exceed the available balance.");
                return false;
            }

            return true;
        }
    </script>
</body>
</html>
